from igra import Game, Uporabnik
import bottle
import random
import os

directory_path = os.getcwd()

with open("igre.json", "w") as d:
    print("{}", file=d)


uporabnik = Uporabnik()
argumenti = uporabnik.argumenti


@bottle.get("/")
def osnovni_zaslon():
    # c = bottle.request.query
    # c = bottle.request.query.getunicode()
    # print(c)
    # bottle.redirect()
    return bottle.template("osnovni_zaslon.html", argumenti=argumenti)


@bottle.get("/nova-igra/<nasprotnik>/<velikost>/<barva>/")
def nova_igra(nasprotnik, velikost, barva):
    return bottle.template("nova_igra.html", argumenti=argumenti)


@bottle.post("/nova-igra-posodobi/<nasprotnik:int>/<velikost:int>/<barva:int>/")
def nova_igra(nasprotnik, velikost, barva):
    print(nasprotnik, velikost, barva, type(nasprotnik))
    argumenti["nasprotnik"] = bool(nasprotnik)
    argumenti["tezavnost"] = nasprotnik if nasprotnik else argumenti["tezavnost"]
    argumenti["velikost"] = velikost
    argumenti["barva"] = barva
    bottle.redirect(
        f"/nova-igra/{argumenti['tezavnost'] if argumenti['nasprotnik'] else 0}/{argumenti['velikost']}/{argumenti['barva']}/"
    )


@bottle.post("/ustvari-novo-igro/")
def ustvari_novo_igro():
    if argumenti["nasprotnik"]:
        nasprotnik = f"Računalnik, težavnostna stopnja {argumenti['tezavnost']}"
    elif argumenti["uporabnik"] is None:
        nasprotnik = "Uporabnik 2"
    else:
        nasprotnik = bottle.request.forms.getunicode("ime")

    uporabnik = (
        f"Uporabnik {'1' if nasprotnik == 'Uporabnik 2' else ''}"
        if argumenti["uporabnik"] is None
        else argumenti["uporabnik"]
    )

    # print(nasprotnik)
    r = random.randint(0, 1) if not argumenti["barva"] else argumenti["barva"]
    argumenti["trenutna_igra"] = Game(
        size_y=argumenti["velikost"],  # to bi se dalo spremeniti
        size_x=argumenti["velikost"],
        player1=uporabnik if r == 1 else nasprotnik,
        player2=nasprotnik if r == 1 else uporabnik,
        ai_move=1 - 2 * r if argumenti["nasprotnik"] else None,
        ai_version=argumenti["tezavnost"],
    )
    bottle.redirect("/trenutna-igra/")


@bottle.post("/oddaj-potezo/<y:int>/<x:int>/")
def oddaj_potezo(y, x):
    argumenti["trenutna_igra"].loop(y, x)  # loop
    bottle.redirect("/trenutna-igra/")


@bottle.post("/potezo-nazaj/")
def oddaj_potezo():
    argumenti["trenutna_igra"].take_back()
    # print(argumenti["trenutna_igra"].take_backs)
    bottle.redirect("/trenutna-igra/")


@bottle.post("/potezo-naprej/")
def oddaj_potezo():
    argumenti["trenutna_igra"].undo_take_back()
    bottle.redirect("/trenutna-igra/")


@bottle.get("/trenutna-igra/")
def trenutna_igra():
    global argumenti
    return bottle.template("trenutna_igra.html", argumenti=argumenti)


@bottle.get("/navodila/")
def nova_igra():
    return bottle.template("navodila.html", argumenti=argumenti)


@bottle.get("/uporabniski-racun/")
def uporabniski_racun():   
    return bottle.template("uporabniski_racun.html", argumenti=argumenti)


@bottle.post("/prijava/")
def uporabniski_racun_prijava():
    global argumenti
    uporabnisko_ime = bottle.request.forms.getunicode("uporabniskoIme")
    geslo = bottle.request.forms.getunicode("geslo")
    ustreza = uporabnik.prijava(uporabnisko_ime, geslo)
    if ustreza is None:
        argumenti = uporabnik.argumenti
        print(argumenti)
        bottle.redirect("/zgodovina/")
    else:
        uporabnik.argumenti["napacno_geslo"] = ustreza
        bottle.redirect("/uporabniski-racun/")


@bottle.post("/registracija/")
def uporabniski_racun_registracija():
    global argumenti
    uporabnisko_ime = bottle.request.forms.getunicode("uporabniskoIme")
    geslo = bottle.request.forms.getunicode("geslo")
    ponovljeno_geslo = bottle.request.forms.getunicode("ponovnoGeslo")

    ustreza = uporabnik.registacija(uporabnisko_ime, geslo, ponovljeno_geslo)
    if ustreza is None:
        argumenti = uporabnik.argumenti
        bottle.redirect("/zgodovina/")
    else:
        uporabnik.argumenti["napacno_geslo"] = ustreza
        bottle.redirect("/uporabniski-racun/")



@bottle.post("/odjava/")
def odjava():
    global argumenti, uporabnik
    uporabnik.odjava()
    uporabnik = Uporabnik()
    argumenti = uporabnik.argumenti
    bottle.redirect("/uporabniski-racun/")
    # uporabniski_racun()


@bottle.get("/zgodovina/")
def uporabniski_racun():
    return bottle.template("zgodovina.html", argumenti=argumenti)


@bottle.route("/static/<filename>")
def server_static(filename):
    return bottle.static_file(filename, root=f"{directory_path}\static")


#@bottle.route("/static/<filename>")
#def server_static(filename):
#    return bottle.static_file(filename, root=f"{directory_path}\static")


bottle.run(debug=True, reloader=True)
